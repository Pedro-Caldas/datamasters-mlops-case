name: CI

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Create .env from example
        run: |
          cp infra/.env.example infra/.env

      - name: Run code quality checks
        run: |
          make lint

      - name: Run unit tests
        run: |
          make test

      - name: Generate processed dataset
        run: |
          make data-bank

      - name: Smoke test - training
        env:
          CI: "1"
        run: |
          make train-bank MODEL_NAME=ci-test

      - name: Promote model to Production (local registry)
        env:
          CI: "1"
        run: |
          python - << 'EOF'
          from mlflow.tracking import MlflowClient

          client = MlflowClient(tracking_uri="file:./mlruns-ci")

          name = "ci-test"
          versions = client.search_model_versions(f"name='{name}'")

          if not versions:
              raise RuntimeError("Nenhuma versÃ£o foi registrada durante o treino.")

          v = sorted(versions, key=lambda x: int(x.version))[-1]

          client.transition_model_version_stage(
              name=name,
              version=v.version,
              stage="Production",
              archive_existing_versions=True
          )

          print(f"Promovido: {name} v{v.version} -> Production")
          EOF

      - name: Smoke test - prediction
        env:
          CI: "1"
          MODEL_NAME: "ci-test"
          STAGE: "Production"
        run: |
          python - << 'EOF'
          import src.predict_bank as pb

          # Evita erro por falta de Postgres no CI
          pb.save_inference_row = lambda *args, **kwargs: None

          pb.main()
          EOF
